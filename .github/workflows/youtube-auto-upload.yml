# ë§¤ì¼ ìë™ ì‹¤í–‰ (í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œ = UTC 0ì‹œ)
"on":
  schedule:
    - cron: '0 0 * * *'  # ë§¤ì¼ UTC 0ì‹œ (í•œêµ­ ì˜¤ì „ 9ì‹œ)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë„ ê°€ëŠ¥

env:
  TZ: 'Asia/Seoul'

jobs:
  generate-and-upload:
    name: ğŸ¬ AI ì—¬í–‰ ì‡¼ì¸  ìƒì„± ë° ìœ íŠœë¸Œ ì—…ë¡œë“œ
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
    - name: ğŸ“¦ ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    # 2. Python í™˜ê²½ ì„¤ì •
    - name: ğŸ Python 3.10 ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    # 3. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“š Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
      run: |
        pip install --upgrade pip
        pip install requests python-dotenv
        pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
    
    # 4. FFmpeg ì„¤ì¹˜
    - name: ğŸ¬ FFmpeg ì„¤ì¹˜
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y ffmpeg
    
    # 5. í•œê¸€ í°íŠ¸ ì„¤ì¹˜
    - name: ğŸ”¤ í•œê¸€ í°íŠ¸ ì„¤ì¹˜
      run: |
        sudo apt-get install -y fonts-nanum fonts-nanum-coding
        fc-cache -fv
    
    # 6. ì˜¤ë˜ëœ ì˜ìƒ ìë™ ì •ë¦¬ (7ì¼ ì´ìƒ)
    - name: ğŸ§¹ ì˜¤ë˜ëœ ì˜ìƒ ìë™ ì •ë¦¬
      run: |
        python3 scripts/cleanup_old_videos.py
    
    # 7. ì˜ìƒ ìƒì„± ë° ìœ íŠœë¸Œ ì—…ë¡œë“œ
    - name: ğŸŒ ì˜ìƒ ìƒì„± ë° ìœ íŠœë¸Œ ìë™ ì—…ë¡œë“œ
      id: upload
      env:
        PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
        YOUTUBE_TOKEN_BASE64: ${{ secrets.YOUTUBE_TOKEN_BASE64 }}
      run: |
        python3 scripts/full_auto_youtube.py
    
    # 8. ì—…ë¡œë“œ ì™„ë£Œ í›„ ë¡œì»¬ ì˜ìƒ ì‚­ì œ (ì €ì¥ì†Œ ìš©ëŸ‰ ì ˆì•½)
    - name: ğŸ—‘ï¸ ì—…ë¡œë“œëœ ì˜ìƒ ë¡œì»¬ ì‚­ì œ
      if: success()
      run: |
        echo "âœ… ìœ íŠœë¸Œ ì—…ë¡œë“œ ì™„ë£Œ. ë¡œì»¬ ì˜ìƒ ì‚­ì œ ì¤‘..."
        rm -f output/*.mp4
        echo "âœ… MP4 íŒŒì¼ ì‚­ì œ ì™„ë£Œ"
        ls -lh output/ || echo "output í´ë”ê°€ ë¹„ì—ˆìŠµë‹ˆë‹¤"
    
    # 9. ì €ì¥ì†Œì— ë³€ê²½ì‚¬í•­ ì»¤ë°‹ (ì •ë¦¬ëœ ìƒíƒœ ì €ì¥)
    - name: ğŸ’¾ ì •ë¦¬ëœ ì €ì¥ì†Œ ì»¤ë°‹
      if: success()
      run: |
        git config user.name "AI Travel Shorts Bot"
        git config user.email "cogurrl@gmail.com"
        git add -A
        git diff-index --quiet HEAD || git commit -m "chore: ì˜¤ë˜ëœ ì˜ìƒ ìë™ ì •ë¦¬ (${GITHUB_RUN_NUMBER})"
        git push || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
    
    # 10. ìƒì„±ëœ ë©”íƒ€ë°ì´í„°ë¥¼ Artifactë¡œ ë°±ì—… (ì˜ìƒì€ YouTubeì—)
    - name: ğŸ“¤ ë©”íƒ€ë°ì´í„° ë°±ì—… (Artifact)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: travel-shorts-metadata-${{ github.run_number }}
        path: |
          output/*_metadata.json
          logs/cleanup_*.json
        retention-days: 7
    
    # 11. ì €ì¥ì†Œ ìš©ëŸ‰ í™•ì¸
    - name: ğŸ“Š ì €ì¥ì†Œ ìš©ëŸ‰ í™•ì¸
      if: always()
      run: |
        echo "ğŸ“Š ì €ì¥ì†Œ ìš©ëŸ‰ í˜„í™©:"
        du -sh . 2>/dev/null || echo "ì „ì²´: N/A"
        du -sh output/ 2>/dev/null || echo "output: 0 MB (ì •ë¦¬ë¨)"
        du -sh logs/ 2>/dev/null || echo "logs: N/A"
        echo ""
        echo "âš ï¸ GitHub Free í•œë„: 500MB"
        echo "âœ… ArtifactsëŠ” ë³„ë„ 2GB (ìë™ ì •ë¦¬)"
    
    # 12. ì‹¤í–‰ ìš”ì•½
    - name: ğŸ“Š ì‹¤í–‰ ìš”ì•½
      if: always()
      run: |
        echo "================================"
        echo "ğŸŒ AI ì—¬í–‰ ì‡¼ì¸  ìë™í™” ì™„ë£Œ"
        echo "================================"
        echo "ì‹¤í–‰ ë²ˆí˜¸: ${{ github.run_number }}"
        echo "ìƒíƒœ: ${{ job.status }}"
        echo "ì‹œê°„: $(date)"
        echo "================================"
